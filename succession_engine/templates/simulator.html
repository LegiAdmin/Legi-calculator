<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Succession Engine - Simulateur Complet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
                üèõÔ∏è Moteur de Succession - Interface de Test
            </h1>
            <p class="text-gray-600 mt-2">Simulateur complet avec liquidation matrimoniale, donations, r√©serve, option
                conjoint, assurance-vie et dettes</p>
        </div>

        <div class="grid grid-cols-12 gap-6">

            <!-- Sidebar: Scenarios -->
            <div class="col-span-12 lg:col-span-3 bg-white rounded-lg shadow-lg p-4">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <span>üìã</span> Sc√©narios de Test
                </h2>
                <div id="scenarioList" class="space-y-2 mb-4 max-h-[600px] overflow-y-auto">
                    <p class="text-gray-500 text-sm">Chargement...</p>
                </div>

                <div class="border-t pt-4">
                    <h3 class="font-semibold mb-2 text-sm">Sauvegarder</h3>
                    <input type="text" id="newScenarioName" placeholder="Nom du sc√©nario"
                        class="w-full p-2 border rounded mb-2 text-sm">
                    <button id="saveScenarioBtn"
                        class="w-full bg-green-600 text-white py-2 px-3 rounded text-sm hover:bg-green-700 transition">
                        üíæ Sauvegarder
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-span-12 lg:col-span-9 space-y-6">

                <!-- Input JSON -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2">
                        <span>‚öôÔ∏è</span> Donn√©es d'entr√©e (JSON)
                    </h2>
                    <form id="simulationForm">
                        <textarea id="jsonInput" rows="12"
                            class="w-full p-4 border-2 rounded-lg font-mono text-sm bg-gray-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"
                            placeholder="Collez le JSON SimulationInput ici...">
{
  "matrimonial_regime": "SEPARATION",
  "assets": [
    {
      "id": "maison",
      "estimated_value": 300000,
      "ownership_mode": "FULL_OWNERSHIP",
      "asset_origin": "PERSONAL_PROPERTY"
    }
  ],
  "members": [
    {
      "id": "child1",
      "birth_date": "1990-01-01",
      "relationship": "CHILD"
    }
  ],
  "wishes": {
    "has_spouse_donation": false,
    "testament_distribution": "LEGAL"
  }
}
                        </textarea>
                        <button type="submit"
                            class="w-full mt-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition font-semibold text-lg shadow-lg">
                            üöÄ Lancer la Simulation
                        </button>
                    </form>
                </div>

                <!-- Results Section (Full Width Below Input) -->
                <div id="resultsContainer" class="hidden">

                    <!-- Calculation Steps -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                            <span>üìä</span> √âtapes de Calcul
                        </h2>
                        <div id="calculationSteps" class="space-y-3"></div>
                    </div>

                    <!-- Warnings -->
                    <div id="warningsContainer"
                        class="hidden bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-bold mb-3 text-yellow-800 flex items-center gap-2">
                            <span>‚ö†Ô∏è</span> Avertissements
                        </h2>
                        <div id="warningsList" class="space-y-2"></div>
                    </div>

                    <!-- Global Metrics -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                            <span>üí∞</span> Synth√®se Globale
                        </h2>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="globalMetrics"></div>
                    </div>

                    <!-- Assets Breakdown -->
                    <div id="assetsContainer" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                            <span>üè†</span> D√©tail des Actifs
                        </h2>
                        <div id="assetsBreakdown" class="space-y-3"></div>
                    </div>

                    <!-- Heirs Breakdown -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                            <span>üë•</span> R√©partition par H√©ritier
                        </h2>
                        <div id="heirsBreakdown" class="grid grid-cols-1 gap-4"></div>
                    </div>

                </div>

                <!-- Initial Message -->
                <div id="initialMessage" class="bg-white rounded-lg shadow-lg p-12 text-center">
                    <div class="text-6xl mb-4">üéØ</div>
                    <h3 class="text-2xl font-bold text-gray-700 mb-2">Pr√™t √† calculer</h3>
                    <p class="text-gray-500">Chargez un sc√©nario ou √©ditez le JSON ci-dessus, puis lancez la simulation.
                    </p>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Load Scenarios on Start
        document.addEventListener('DOMContentLoaded', loadScenarios);

        async function loadScenarios() {
            const list = document.getElementById('scenarioList');
            try {
                const res = await fetch('/api/scenarios/');
                const scenarios = await res.json();

                if (scenarios.length === 0) {
                    list.innerHTML = '<p class="text-gray-400 text-sm italic">Aucun sc√©nario sauvegard√©.</p>';
                    return;
                }

                // Group scenarios by category (emoji in name)
                list.innerHTML = scenarios.map(s => `
                    <div class="p-3 border-2 rounded-lg hover:bg-blue-50 hover:border-blue-400 cursor-pointer group transition" 
                         onclick='loadScenario(${JSON.stringify(s.input_data)})'>
                        <div class="font-semibold text-sm text-gray-800 group-hover:text-blue-700">${s.name}</div>
                        <div class="text-xs text-gray-500 mt-1">${s.description || ''}</div>
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<p class="text-red-500 text-sm">Erreur de chargement.</p>';
            }
        }

        function loadScenario(data) {
            document.getElementById('jsonInput').value = JSON.stringify(data, null, 2);
        }

        document.getElementById('saveScenarioBtn').addEventListener('click', async () => {
            const name = document.getElementById('newScenarioName').value;
            const inputData = document.getElementById('jsonInput').value;

            if (!name) { alert("Veuillez entrer un nom."); return; }

            try {
                const json = JSON.parse(inputData);
                const res = await fetch('/api/scenarios/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ name: name, input_data: json })
                });

                if (res.ok) {
                    document.getElementById('newScenarioName').value = '';
                    loadScenarios();
                    alert('‚úÖ Sc√©nario sauvegard√© !');
                } else {
                    alert("Erreur lors de la sauvegarde.");
                }
            } catch (err) {
                alert("JSON invalide dans la zone de saisie.");
            }
        });

        document.getElementById('simulationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const jsonInput = document.getElementById('jsonInput').value;

            try {
                const parsedInput = JSON.parse(jsonInput);

                // Show loading
                document.getElementById('initialMessage').classList.add('hidden');
                document.getElementById('resultsContainer').classList.remove('hidden');
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-12 text-center">
                        <div class="text-6xl mb-4">‚è≥</div>
                        <h3 class="text-2xl font-bold text-gray-700">Calcul en cours...</h3>
                    </div>
                `;

                // Call API
                const response = await fetch('/api/simulate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(parsedInput)
                });

                const data = await response.json();

                if (response.ok) {
                    renderResults(data);
                } else {
                    document.getElementById('resultsContainer').innerHTML = `
                        <div class="bg-red-50 border-2 border-red-500 rounded-lg p-6">
                            <h3 class="text-xl font-bold text-red-700 mb-2">‚ùå Erreur</h3>
                            <pre class="font-mono text-sm text-red-600 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }

            } catch (err) {
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="bg-red-50 border-2 border-red-500 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-red-700 mb-2">‚ùå Erreur JSON</h3>
                        <p class="text-red-600">${err.message}</p>
                    </div>
                `;
            }
        });

        function renderResults(data) {
            const metrics = data.global_metrics;
            const heirs = data.heirs_breakdown;
            const steps = data.calculation_steps || [];
            const assets = data.assets_breakdown || [];
            const warnings = data.warnings || [];

            // Show results container
            document.getElementById('initialMessage').classList.add('hidden');
            const container = document.getElementById('resultsContainer');
            container.classList.remove('hidden');
            container.innerHTML = `
                <!-- Calculation Steps -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üìä</span> √âtapes de Calcul
                    </h2>
                    <div id="calculationSteps" class="space-y-3"></div>
                </div>

                <!-- Warnings -->
                <div id="warningsContainer" class="${warnings.length > 0 ? '' : 'hidden'} bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-3 text-yellow-800 flex items-center gap-2">
                        <span>‚ö†Ô∏è</span> Avertissements Juridiques
                    </h2>
                    <div id="warningsList" class="space-y-2"></div>
                </div>

                <!-- Global Metrics -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üí∞</span> Synth√®se Globale
                    </h2>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="globalMetrics"></div>
                </div>

                <!-- Assets Breakdown -->
                <div id="assetsContainer" class="${assets.length > 0 ? '' : 'hidden'} bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üè†</span> D√©tail des Actifs
                    </h2>
                    <div id="assetsBreakdown" class="space-y-3"></div>
                </div>

                <!-- Heirs Breakdown -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üë•</span> R√©partition par H√©ritier
                    </h2>
                    <div id="heirsBreakdown" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
                </div>
            `;

            // Render Calculation Steps
            const stepsHtml = steps.map(step => {
                const colors = ['blue', 'green', 'purple', 'orange', 'pink'];
                const color = colors[step.step_number - 1] || 'gray';
                return `
                    <div class="bg-${color}-50 border-l-4 border-${color}-500 p-4 rounded-lg hover:shadow-md transition">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-${color}-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">${step.step_number}</span>
                            <span class="font-bold text-lg text-${color}-900">${step.step_name}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${step.description}</p>
                        <p class="text-sm font-semibold text-${color}-700">‚Üí ${step.result_summary}</p>
                    </div>
                `;
            }).join('');
            document.getElementById('calculationSteps').innerHTML = stepsHtml;

            // Render Warnings
            if (warnings.length > 0) {
                const warningsHtml = warnings.map(w => `
                    <div class="bg-white border-l-4 border-yellow-500 p-3 rounded shadow-sm text-sm">
                        ${w}
                    </div>
                `).join('');
                document.getElementById('warningsList').innerHTML = warningsHtml;
            }

            // Render Global Metrics
            const metricsHtml = `
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-md">
                    <div class="text-xs opacity-80 mb-1">Masse Successorale</div>
                    <div class="text-2xl font-bold">${formatCurrency(metrics.total_estate_value)}</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow-md">
                    <div class="text-xs opacity-80 mb-1">R√©serve H√©r√©ditaire</div>
                    <div class="text-2xl font-bold">${formatCurrency(metrics.legal_reserve_value)}</div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-md">
                    <div class="text-xs opacity-80 mb-1">Quotit√© Disponible</div>
                    <div class="text-2xl font-bold">${formatCurrency(metrics.disposable_quota_value)}</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-4 rounded-lg shadow-md">
                    <div class="text-xs opacity-80 mb-1">Droits Totaux</div>
                    <div class="text-2xl font-bold">${formatCurrency(metrics.total_tax_amount)}</div>
                </div>
            `;
            document.getElementById('globalMetrics').innerHTML = metricsHtml;

            // Render Assets
            if (assets.length > 0) {
                const assetsHtml = assets.map(asset => {
                    const isDonation = asset.asset_origin === 'DONATION';
                    const isLifeInsurance = asset.notes.some(n => n.includes('assurance-vie'));
                    const icon = isDonation ? 'üìú' : isLifeInsurance ? 'üí∞' : 'üè†';
                    const bgColor = isDonation ? 'bg-purple-50 border-purple-300' : isLifeInsurance ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-300';

                    return `
                        <div class="${bgColor} border-2 p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${icon}</span>
                                    <span class="font-bold text-gray-800">${asset.asset_id}</span>
                                </div>
                                <span class="font-bold text-xl text-blue-600">${formatCurrency(asset.asset_value)}</span>
                    </div>
                            <div class="text-sm text-gray-600 mb-2">
                                <span class="bg-white px-2 py-1 rounded">${asset.ownership_mode}</span>
                                <span class="bg-white px-2 py-1 rounded ml-2">${asset.asset_origin}</span>
                            </div>
                            ${asset.notes.length > 0 ? `
                                <div class="text-xs text-gray-700 space-y-1 mt-2 border-t pt-2">
                                    ${asset.notes.map(note => `<div>‚Ä¢ ${note}</div>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                document.getElementById('assetsBreakdown').innerHTML = assetsHtml;
            }

            // Render Heirs
            const heirsHtml = heirs.map(heir => {
                return `
                    <div class="bg-gradient-to-br from-white to-gray-50 p-5 rounded-lg shadow-md border-2 border-blue-200 hover:border-blue-400 transition">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-xl text-gray-800">${heir.name}</span>
                            <span class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-bold">${heir.legal_share_percent.toFixed(1)}%</span>
                        </div>
                        
                        <div class="space-y-2 text-sm mb-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Part brute</span>
                                <span class="font-semibold">${formatCurrency(heir.gross_share_value)}</span>
                            </div>
                            <div class="flex justify-between text-green-600">
                                <span>Abattement</span>
                                <span class="font-semibold">- ${formatCurrency(heir.abatement_used)}</span>
                            </div>
                            <div class="flex justify-between border-t pt-2">
                                <span class="text-gray-600">Base taxable</span>
                                <span class="font-semibold">${formatCurrency(heir.taxable_base)}</span>
                            </div>
                            <div class="flex justify-between text-red-600">
                                <span>Droits de succession</span>
                                <span class="font-semibold">${formatCurrency(heir.tax_amount)}</span>
                            </div>
                            <div class="flex justify-between border-t pt-2 text-lg">
                                <span class="font-bold text-gray-800">Part nette</span>
                                <span class="font-bold text-green-600">${formatCurrency(heir.net_share_value)}</span>
                            </div>
                        </div>

                        ${heir.tax_calculation_details && heir.tax_calculation_details.brackets_applied.length > 0 ? `
                            <details class="mt-3">
                                <summary class="text-sm text-blue-600 cursor-pointer hover:text-blue-800 font-semibold flex items-center gap-1">
                                    <span>üìä</span> D√©tail fiscal complet
                                </summary>
                                <div class="mt-3 p-3 bg-blue-50 rounded-lg text-xs space-y-2 border border-blue-200">
                                    <div><strong>Relation :</strong> ${heir.tax_calculation_details.relationship}</div>
                                    <div><strong>Abattement (${heir.tax_calculation_details.allowance_name}) :</strong> ${formatCurrency(heir.tax_calculation_details.allowance_amount)}</div>
                                    <div class="font-semibold mt-2 text-sm">Bar√®me fiscal appliqu√© :</div>
                                    ${heir.tax_calculation_details.brackets_applied.map((bracket, i) => {
                    const maxDisplay = bracket.bracket_max ? formatCurrency(bracket.bracket_max) : '‚àû';
                    const taxableAmount = bracket.taxable_in_bracket || 0;
                    const taxAmount = bracket.tax_for_bracket || 0;  // Correct field name
                    const rate = bracket.rate || 0;
                    return `
                                            <div class="pl-3 border-l-2 border-blue-400 bg-white p-2 rounded">
                                                <div class="font-semibold">Tranche ${i + 1} : ${formatCurrency(bracket.bracket_min || 0)} ‚Üí ${maxDisplay}</div>
                                                <div>${formatCurrency(taxableAmount)} √ó ${(rate * 100).toFixed(0)}% = ${formatCurrency(taxAmount)}</div>
                                            </div>
                                        `;
                }).join('')}
                                    <div class="border-t pt-2 font-bold text-sm">
                                        Total des droits : ${formatCurrency(heir.tax_amount)}
                                    </div>
                                </div>
                            </details>
                        ` : ''}
                    </div>
                `;
            }).join('');
            document.getElementById('heirsBreakdown').innerHTML = heirsHtml;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

</body>

</html>